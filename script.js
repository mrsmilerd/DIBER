// =============================================
// UBER CALC - Calculadora Inteligente para Conductores
// Versi√≥n con Sistema de C√≥digo de Usuario para Multi-Dispositivo
// =============================================

// --- Variables Globales ---
let perfiles = [];
let perfilActual = null;
let historial = [];
let calculoActual = null;
let timeoutCalculo = null;
let googleSync;

// --- Sistema de C√≥digo de Usuario ---
let userCodeSystem = {
    userId: null,
    userCode: null,
    initialized: false
};

// --- Configuraci√≥n Google Apps Script ---
// Usa tu URL real aqu√≠.
const GOOGLE_SCRIPT_BASE_URL = 'https://script.google.com/macros/s/AKfycbzhDlVDb6B4nLnpgVuaPNk7hq6Srs5zGW2iqd4uiKnmBaLpk0_fyAUypNpwaoYJs0lZiQ/exec';
const LOCAL_SYNC_ENDPOINT = '/api/sync'; 
const GOOGLE_SCRIPT_URL = LOCAL_SYNC_ENDPOINT;


// =============================================
// PERSISTENCIA DE DATOS (FUNCIONES CR√çTICAS PARA LA SINCRONIZACI√ìN)
// =============================================

/**
 * Guarda los arrays 'perfiles' e 'historial' en LocalStorage y los sincroniza con Google Sheets (Nube).
 * Historial de viajes incluido.
 */
function guardarDatos() {
    console.log('üíæ Guardando datos en local storage...');
    
    // Guardar en LocalStorage (Cach√© y fallback)
    localStorage.setItem('ubercalc_perfiles', JSON.stringify(perfiles));
    localStorage.setItem('ubercalc_historial', JSON.stringify(historial));
    if (perfilActual) {
        localStorage.setItem('ubercalc_perfil_actual_id', perfilActual.id);
    }

    // Sincronizar con Google Sheets (CORRECCI√ìN: Incluye Historial)
    if (window.googleSync && googleSync.initialized) {
        console.log('‚òÅÔ∏è Sincronizando datos con Google Sheets...');
        
        // 1. Sincronizar Perfiles
        googleSync.saveProfiles(perfiles) 
            .then(() => console.log('‚úÖ Perfiles guardados en la nube'))
            .catch(error => console.warn('‚ö†Ô∏è Error al guardar perfiles:', error));

        // 2. Sincronizar Historial (CR√çTICO)
        if (typeof googleSync.saveHistory === 'function') {
             googleSync.saveHistory(historial)
                .then(() => console.log('‚úÖ Historial guardado en la nube'))
                .catch(error => console.warn('‚ö†Ô∏è Error al guardar historial:', error));
        } else {
            console.warn('‚ö†Ô∏è googleSync.saveHistory no est√° definida. El historial NO se sincronizar√°.');
        }

    } else {
        console.warn('‚ö†Ô∏è Google Sync no inicializado o no disponible. Solo se guarda en local.');
    }
}

/**
 * Carga los datos, dando prioridad a Google Sheets (Nube) si el usuario tiene un c√≥digo asociado.
 */
async function cargarDatos() {
    console.log('üîÑ Cargando datos (local y nube)...');
    let cloudPerfiles = null;

    // 1. Intentar cargar desde la nube (PRIORIDAD)
    if (window.googleSync && googleSync.initialized) {
        try {
            console.log('‚òÅÔ∏è Intentando cargar perfiles desde la nube...');
            cloudPerfiles = await googleSync.loadProfiles(); 
            
            if (cloudPerfiles && cloudPerfiles.length > 0) {
                console.log('‚úÖ Perfiles cargados de la nube:', cloudPerfiles.length);
                perfiles = cloudPerfiles;
            } else if (window.userCodeSystem && userCodeSystem.initialized) {
                // Sube datos locales si el c√≥digo no tiene nada en la nube (PC -> Primer Sync)
                const localPerfilesString = localStorage.getItem('ubercalc_perfiles');
                const localPerfiles = localPerfilesString ? JSON.parse(localPerfilesString) : [];

                if (localPerfiles.length > 0) {
                    console.log('‚¨ÜÔ∏è Nube vac√≠a. Subiendo perfiles locales...');
                    await googleSync.saveProfiles(localPerfiles);
                    perfiles = localPerfiles;
                }
            }
            
            // 2. Cargar historial desde la nube (si existe la funci√≥n)
            if (typeof googleSync.loadHistory === 'function') {
                const cloudHistorial = await googleSync.loadHistory();
                if (cloudHistorial && cloudHistorial.length > 0) {
                    historial = cloudHistorial;
                    console.log('‚úÖ Historial cargado de la nube:', historial.length);
                }
            }
            
        } catch (error) {
            console.error('‚ùå Error al cargar datos de la nube. Usando local storage.', error);
        }
    }
    
    // 3. Cargar de LocalStorage si la nube NO proporcion√≥ perfiles (fallback)
    if (!perfiles || perfiles.length === 0) {
        console.log('üíæ Cargando perfiles de localStorage...');
        const localPerfilesString = localStorage.getItem('ubercalc_perfiles');
        perfiles = localPerfilesString ? JSON.parse(localPerfilesString) : [];
        
        // Cargar historial local (si no se carg√≥ de la nube)
        const localHistorialString = localStorage.getItem('ubercalc_historial');
        historial = localHistorialString ? JSON.parse(localHistorialString) : [];
    }
    
    // 4. Establecer perfil actual
    const lastProfileId = localStorage.getItem('ubercalc_perfil_actual_id');
    if (perfiles.length > 0) {
        perfilActual = perfiles.find(p => p.id === lastProfileId) || perfiles[0];
        if (perfilActual) {
            localStorage.setItem('ubercalc_perfil_actual_id', perfilActual.id);
        }
    } else {
        perfilActual = null;
    }
    
    console.log(`‚úÖ Carga de datos finalizada. Perfiles: ${perfiles.length}, Historial: ${historial.length}`);
}

// =============================================
// SISTEMA DE C√ìDIGO DE USUARIO - MULTIDISPOSITIVO
// =============================================

async function initializeUserCodeSystem() {
    // ... C√ìDIGO ORIGINAL DE initializeUserCodeSystem
}

async function generateUserCode() {
    // ... C√ìDIGO ORIGINAL DE generateUserCode
}

async function setUserCode(code) {
    // ... C√ìDIGO ORIGINAL DE setUserCode
}

function showUserCodeModal() {
    // ... C√ìDIGO ORIGINAL DE showUserCodeModal
}

function hideUserCodeModal() {
    // ... C√ìDIGO ORIGINAL DE hideUserCodeModal
}

function showUserCodeBanner() {
    // ... C√ìDIGO ORIGINAL DE showUserCodeBanner
}

function debugUserCodeModal() {
    // ... C√ìDIGO ORIGINAL DE debugUserCodeModal
}

function pruebaDirectaGoogleSheets() {
    // ... C√ìDIGO ORIGINAL DE pruebaDirectaGoogleSheets
}

// =============================================
// C√ÅLCULOS Y FUNCIONES DE CORE
// =============================================

async function calcularViaje(event) {
    // ... C√ìDIGO ORIGINAL DE calcularViaje
}

function procesarViaje(aceptado) {
    // C√ìDIGO CORREGIDO: Llama a guardarDatos() despu√©s de guardar el historial
    if (!calculoActual) {
        mostrarError('No hay c√°lculo actual para procesar');
        return;
    }
    
    if (aceptado) {
        guardarEnHistorial(calculoActual, true);
        mostrarStatus('‚úÖ Viaje aceptado y guardado en historial', 'success');
    } else {
        guardarEnHistorial(calculoActual, false);
        mostrarStatus('‚ùå Viaje rechazado', 'info');
    }
    
    // üîë SINCRONIZACI√ìN DE HISTORIAL
    guardarDatos(); 
    
    actualizarEstadisticas();
    limpiarFormulario();
    cerrarModal();
    
    if (aceptado) {
        setTimeout(() => cambiarPestana('historial'), 500);
    }
}

async function guardarPerfil(event) {
    // C√ìDIGO CORREGIDO: Llama a guardarDatos() despu√©s de guardar el perfil
    // ... C√ìDIGO ORIGINAL DE guardarPerfil para obtener y validar datos
    
    // --- 2. Actualizar/Crear Perfil en el array ---
    const index = perfiles.findIndex(p => p.id === perfil.id);
    
    if (index > -1) {
        perfiles[index] = perfil;
        mostrarNotificacion('Perfil actualizado correctamente.', 'success');
    } else {
        perfiles.push(perfil);
        mostrarNotificacion('Nuevo perfil creado correctamente.', 'success');
    }
    
    // üîë SINCRONIZACI√ìN DE PERFIL
    guardarDatos(); 

    // ... C√ìDIGO ORIGINAL DE guardarPerfil para actualizar interfaz
}


// ... (Incluye aqu√≠ todas las dem√°s funciones de tu proyecto: guardarEnHistorial, limpiarHistorial, actualizarEstadisticas, etc.)
// ... Por ejemplo, la funci√≥n que causaba el error:

function actualizarSelectorPerfiles() {
    // ... C√ìDIGO ORIGINAL DE actualizarSelectorPerfiles
}

// =============================================
// FUNCI√ìN DE CONTROL DE SESI√ìN (UBICACI√ìN FINAL Y SEGURA)
// =============================================

/**
 * Inicia el proceso de cambio de usuario:
 * 1. Limpia el c√≥digo, ID y datos de la sesi√≥n actual (perfiles/historial) de la memoria y LocalStorage.
 * 2. Muestra el modal para que el usuario ingrese un c√≥digo nuevo o existente.
 * * NOTA: Colocada aqu√≠ al final para asegurar que todas las funciones de UI ya est√°n definidas.
 */
function cambiarUsuario() {
    console.log('üîÑ Iniciando cambio de usuario. Limpiando sesi√≥n y memoria...');
    
    // 1. Limpiar c√≥digo y ID de usuario en LocalStorage
    localStorage.removeItem('ubercalc_user_code'); 
    localStorage.removeItem('ubercalc_user_id');
    localStorage.removeItem('uberCalc_data');
    
    // 2. Resetear el estado del sistema de sincronizaci√≥n en memoria
    userCodeSystem.userCode = null;
    userCodeSystem.userId = null;
    userCodeSystem.initialized = false;
    
    // 3. Reiniciar los arrays de datos en memoria (¬°SOLUCI√ìN AL ERROR DE PERFIL PERSISTENTE!)
    perfiles = [];
    perfilActual = null;
    historial = [];
    
    // 4. Resetear la interfaz (AHORA ESTA FUNCI√ìN ESTAR√Å DEFINIDA)
    actualizarSelectorPerfiles(); 
    
    // 5. Ocultar banners 
    const banner = document.getElementById('user-code-banner');
    const bannerMain = document.getElementById('user-code-banner-main');
    if (banner) banner.style.display = 'none';
    if (bannerMain) bannerMain.style.display = 'none';
    
    // 6. Mostrar el modal de c√≥digo para la nueva entrada
    showUserCodeModal(); 
    
    console.log('‚úÖ Sesi√≥n reiniciada. Los datos anteriores se borraron de la memoria.');
}


// =============================================
// C√ìDIGO FINAL DE INICIALIZACI√ìN Y LISTENERS
// =============================================

// --- Exposici√≥n Global (Aseg√∫rate de que tus funciones est√©n aqu√≠) ---
window.guardarDatos = guardarDatos;
window.cargarDatos = cargarDatos;
// ... (otras funciones originales)
window.actualizarSelectorPerfiles = actualizarSelectorPerfiles;
// ... (Otras asignaciones de funciones de UI)

// Nuevas funciones globales para el sistema de c√≥digo
window.generateUserCode = generateUserCode;
window.setUserCode = setUserCode;
window.showUserCodeModal = showUserCodeModal;
window.debugUserCodeModal = debugUserCodeModal;
window.pruebaDirectaGoogleSheets = pruebaDirectaGoogleSheets;
window.cambiarUsuario = cambiarUsuario; // üëà ¬°CLAVE PARA EL HTML!

// --- Prevenir cierre accidental ---
window.addEventListener('beforeunload', function(e) {
    // ... C√ìDIGO ORIGINAL
});

// --- Cerrar modal al hacer clic fuera ---
window.onclick = function(event) {
    // ... C√ìDIGO ORIGINAL
}

// --- Forzar c√°lculo inicial si hay datos ---
setTimeout(() => {
    // ... C√ìDIGO ORIGINAL
}, 100);
